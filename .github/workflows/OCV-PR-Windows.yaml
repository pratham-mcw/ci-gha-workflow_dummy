name: OCV PR Windows

on:
  pull_request:
    branches:
      - main
    paths:
      - '.github/workflows/OCV-PR-Windows.yaml'
      - 'checkout-and-merge/*'
      - 'configure-and-build/*'
      - 'run-tests/*'
      - 'scripts/runner.py'
      - 'scripts/test-plan.json'
  workflow_call:
    inputs:
      workflow_branch:
        description: "Branch for ci-gha-workflow repository"
        default: "main"
        required: false
        type: string
  workflow_dispatch:

concurrency:
  group: OCV-PR-Windows-${{ github.ref }}
  cancel-in-progress: true

jobs:
  Windows:
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      max-parallel: 2
      matrix:
        arch: [ x86, x64, arm64 ]
        config: [ base ]
        branch: [ '4.x' ]
        include:
          - arch: x86
            config: base
            runner: windows-latest
            vs: 'Visual Studio 16 2019'
            cmake_arch: Win32
          - arch: x64
            config: base
            runner: windows-latest
            vs: 'Visual Studio 16 2019'
            cmake_arch: x64
          - arch: arm64
            config: base
            runner: windows-latest
            vs: 'Visual Studio 17 2022'
            cmake_arch: ARM64
            no_opencl: true

    defaults:
      run:
        shell: bash
    
    env:
      CMAKE_OPT: >-
        -DCL_Z_OPTION=/Z7
        -DBUILD_EXAMPLES=ON
        -DOPENCV_ENABLE_NONFREE=ON
        ${{ matrix.no_opencl && '-DWITH_OPENCL=OFF' || '' }}
        ${{ matrix.arch == 'arm64' && '-DWITH_VULKAN=OFF -DBUILD_opencv_vulkan=OFF -DOPENCV_DNN_VULKAN=OFF -DBUILD_opencv_world=ON -DWITH_ITT=OFF -DWITH_OPENCL=OFF -DWITH_OPENCLAMDBLAS=OFF -DWITH_OPENCLAMDFFT=OFF -DWITH_OPENCL_D3D11_NV=OFF -DWITH_DIRECTML=OFF -DWITH_DIRECTX=OFF -DWITH_ADE=OFF -DCMAKE_DISABLE_FIND_PACKAGE_Vulkan=ON' || '' }}
        ${{ matrix.arch == 'x86' && '-DBUILD_opencv_python3=OFF' || '' }}
      MAIN_BUILD_DIR: "build"
      OPENCV_FOR_THREADS_NUM: 8
      CMAKE_BUILD_PARALLEL_LEVEL: 8

    steps:
    - name: Checkout OpenCV repository
      uses: actions/checkout@v4
      with:
        repository: pratham-mcw/opencv
        ref: ${{ matrix.branch }}
        path: opencv

    - name: Checkout OpenCV contrib
      uses: actions/checkout@v4
      with:
        repository: opencv/opencv_contrib
        ref: ${{ matrix.branch }}
        path: opencv_contrib

    - name: Checkout OpenCV extra
      uses: actions/checkout@v4
      with:
        repository: opencv/opencv_extra
        ref: ${{ matrix.branch }}
        path: opencv_extra

    - name: Setup build directory
      shell: bash
      run: |
        cd opencv
        mkdir -p build

    - name: Configure OpenCV
      shell: bash
      working-directory: opencv/build
      run: |
        cmake -G "${{ matrix.vs }}" -A ${{ matrix.cmake_arch }} \
          -DCMAKE_BUILD_TYPE=Release \
          -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib/modules \
          ${{ env.CMAKE_OPT }} \
          ..

    - name: Build OpenCV
      shell: bash
      working-directory: opencv/build
      run: |
        cmake --build . --config Release --parallel ${{ env.CMAKE_BUILD_PARALLEL_LEVEL }}

    - name: Display build info
      shell: bash
      working-directory: opencv/build
      run: |
        echo "Build completed for ${{ matrix.arch }}"
        ls -la

    - name: Run basic tests (optional)
      if: ${{ matrix.arch != 'arm64' }}
      shell: bash
      working-directory: opencv/build
      continue-on-error: true
      run: |
        ctest -C Release --output-on-failure -j ${{ env.OPENCV_FOR_THREADS_NUM }} || true
